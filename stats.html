<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é—®å·ç»Ÿè®¡é¢æ¿ - æ»å·å¸‚åšç‰©é¦†</title>
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0a1a2e;
      --card:#0f213a;
      --card2:#0d1c33;
      --text:#eaf1ff;
      --muted:#b9c7e6;
      --line:rgba(255,255,255,.10);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 18px;
      --focus: 0 0 0 4px rgba(125, 211, 252, .25);
      --font: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Noto Sans SC", "Microsoft YaHei", Arial;
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      margin: 0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(167,139,250,.35), transparent 60%),
        radial-gradient(900px 520px at 85% 15%, rgba(125,211,252,.28), transparent 55%),
        radial-gradient(900px 700px at 50% 95%, rgba(52,211,153,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 28px 16px 44px;
      min-height: 100vh;
    }
    .container { max-width: 1280px; margin: 0 auto; }
    
    .header {
      display: flex;
      gap: 18px;
      align-items: flex-start;
      justify-content: space-between;
      padding: 22px 22px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .header:before {
      content: "";
      position: absolute;
      inset: -2px;
      background:
        radial-gradient(500px 200px at 0% 0%, rgba(125,211,252,.22), transparent 65%),
        radial-gradient(520px 220px at 100% 0%, rgba(167,139,250,.20), transparent 70%),
        radial-gradient(520px 220px at 60% 120%, rgba(52,211,153,.10), transparent 65%);
      pointer-events: none;
      filter: blur(2px);
      opacity: .9;
    }
    .header > * { position: relative; }
    h1 { margin: 0 0 6px; font-size: 24px; letter-spacing: .3px; }
    .meta { color: var(--muted); font-size: 13.5px; line-height: 1.7; }
    
    .grid { display: grid; gap: 16px; margin-top: 16px; }
    .grid.columns-4 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    
    .card {
      border: 1px solid var(--line);
      background: rgba(15,33,58,.74);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      position: relative;
    }
    .card h3 { 
      margin: 0 0 14px 0;
      font-size: 16px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stat { 
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,.06);
    }
    .stat .label { color: var(--muted); font-size: 13px; }
    .stat .value { font-weight: 600; color: var(--accent); font-size: 14px; }
    
    table { 
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td { 
      padding: 12px 14px;
      text-align: left;
      border-bottom: 1px solid var(--line);
      font-size: 13.5px;
    }
    th { 
      background: rgba(0,0,0,.2);
      color: var(--accent);
      font-weight: 600;
    }
    td { color: var(--text); }
    tr:hover td {
      background: rgba(125,211,252,.05);
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(125,211,252,.15);
      color: var(--accent);
      border-radius: 999px;
      font-size: 11px;
      margin-left: 6px;
      border: 1px solid rgba(125,211,252,.25);
    }
    .empty { 
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }
    .error { color: var(--bad); }
    
    .filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar label {
      color: var(--muted);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    input[type="date"] {
      background: rgba(0,0,0,.2);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      font-family: var(--font);
      font-size: 13px;
    }
    input[type="date"]:focus {
      outline: none;
      box-shadow: var(--focus);
      border-color: rgba(125,211,252,.35);
    }
    button {
      appearance: none;
      border: 0;
      cursor: pointer;
      padding: 9px 14px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
      transition: transform .06s ease, filter .18s ease, background .18s ease;
    }
    button:hover { filter: brightness(1.1); }
    button:active { transform: translateY(1px); }
    
    #filterBtn {
      background: linear-gradient(180deg, rgba(125,211,252,.22), rgba(125,211,252,.12));
      border: 1px solid rgba(125,211,252,.30);
    }
    #resetBtn {
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      color: var(--muted);
    }
    #downloadCsvBtn {
      background: linear-gradient(180deg, rgba(52,211,153,.20), rgba(52,211,153,.10));
      border: 1px solid rgba(52,211,153,.30);
      margin-left: auto;
    }
    #downloadJsonBtn {
      background: linear-gradient(180deg, rgba(251,191,36,.20), rgba(251,191,36,.10));
      border: 1px solid rgba(251,191,36,.30);
    }
    
    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.15);
    }
    
    @media (max-width: 768px) {
      .header { flex-direction: column; }
      .filter-bar { flex-direction: column; align-items: stretch; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>æ»å·å¸‚åšç‰©é¦†æ¸¸å®¢æ»¡æ„åº¦è°ƒæŸ¥ Â· ç»Ÿè®¡é¢æ¿</h1>
        <div class="meta" id="meta">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- æ—¥æœŸç­›é€‰ -->
    <div class="card">
      <h3>ğŸ“… æ—¥æœŸç­›é€‰</h3>
      <div class="filter-bar">
        <label>å¼€å§‹æ—¥æœŸï¼š<input type="date" id="startDate"></label>
        <label>ç»“æŸæ—¥æœŸï¼š<input type="date" id="endDate"></label>
        <button id="filterBtn">ç­›é€‰</button>
        <button id="resetBtn">é‡ç½®</button>
        <button id="downloadCsvBtn">ğŸ“¥ ä¸‹è½½ CSV</button>
        <button id="downloadJsonBtn">ğŸ“¥ ä¸‹è½½ JSON</button>
      </div>
    </div>

    <div class="grid columns-4" id="demographics"></div>

    <div class="card" style="margin-top: 16px;">
      <h3>ğŸ“Š æ»¡æ„åº¦é‡è¡¨å‡å€¼ï¼ˆ1-5ï¼‰</h3>
      <div class="table-wrapper">
        <table id="likert-table">
          <thead>
            <tr><th>é¢˜ç›®</th><th>å‡å€¼</th><th>æ ·æœ¬é‡</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- æäº¤è®°å½•åˆ—è¡¨ï¼ˆæ—¶é—´+IPï¼‰ -->
    <div class="card">
      <h3>ğŸ“ æäº¤è®°å½•</h3>
      <div class="table-wrapper">
        <table id="submissions-table">
          <thead>
            <tr><th>æäº¤æ—¶é—´</th><th>IP åœ°å€</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const demoTitles = {
      gender: 'æ€§åˆ«åˆ†å¸ƒ',
      residence: 'å¸¸ä½åœ°åˆ†å¸ƒ',
      age: 'å¹´é¾„åˆ†å¸ƒ',
      education: 'å—æ•™è‚²ç¨‹åº¦',
      occupation: 'èŒä¸šåˆ†å¸ƒ',
      income: 'æœˆæ”¶å…¥åˆ†å¸ƒ',
      visitCount: 'å‚è§‚æ¬¡æ•°',
      purpose: 'å‚è§‚ç›®çš„',
    };

    // é‡è¡¨é¢˜ç›®æè¿°
    const scaleTitles = {
      // æœ‰å½¢æ€§
      'Q16': 'é¦†å†…ç¯å¢ƒæ•´æ´ä¸å«ç”Ÿ',
      'Q17': 'å±•é™ˆç¡¬ä»¶æ¡ä»¶',
      'Q18': 'æ¸©åº¦é€šé£èˆ’é€‚åº¦',
      'Q19': 'ä¼‘æ†©è®¾æ–½ä¾¿åˆ©æ€§',
      'Q20': 'æ— éšœç¢ä¸ä¾¿æ°‘è®¾æ–½',
      'Q21': 'æŒ‡ç¤ºæ ‡è¯†æ¸…æ™°åº¦',
      // å¯é æ€§
      'Q22': 'å¼€æ”¾æ—¶é—´ä¸å…¥é¦†è§„åˆ™',
      'Q23': 'å±•è§ˆä¿¡æ¯å‡†ç¡®å®Œæ•´',
      'Q24': 'é¢„çº¦å…¥é¦†æµç¨‹å¯é æ€§',
      'Q25': 'å¯¼è§ˆè§£è¯´ä¸“ä¸šæ€§',
      'Q26': 'æ–‡åˆ›å•†å“ä¿¡æ¯é€æ˜åº¦',
      // å“åº”æ€§
      'Q27': 'å’¨è¯¢å¼•å¯¼å“åº”é€Ÿåº¦',
      'Q28': 'æ’é˜Ÿç–å¯¼æ•ˆç‡',
      'Q29': 'è®²è§£æœåŠ¡è·å–ä¾¿åˆ©æ€§',
      'Q30': 'é—®é¢˜å¤„ç†åŠæ—¶æ€§',
      'Q31': 'çº¿ä¸Šä¿¡æ¯æœåŠ¡å“åº”',
      // ä¿è¯æ€§
      'Q32': 'æœåŠ¡æ€åº¦ç¤¼è²Œè§„èŒƒ',
      'Q33': 'ä¸šåŠ¡èƒ½åŠ›ä¸“ä¸šæ°´å¹³',
      'Q34': 'é¦†å†…å®‰å…¨ä¿éšœ',
      'Q35': 'å®‰å…¨æ„Ÿä¸ç§©åºæ„Ÿ',
      // ç§»æƒ…æ€§
      'Q36': 'ä¸åŒç¾¤ä½“å…³æ€€ç¨‹åº¦',
      'Q37': 'ä»¥æ¸¸å®¢ä¸ºä¸­å¿ƒä½“éªŒ',
      'Q38': 'å‚è§‚åŠ¨çº¿äººæ€§åŒ–',
      'Q39': 'å‚è§‚èŠ‚å¥ç©ºé—´ä½“éªŒ',
      // æ–‡æ—…èåˆ
      'Q40': 'åœ°æ–¹æ–‡åŒ–ç‰¹è‰²ä½“ç°',
      'Q41': 'äº’åŠ¨ä¸æ™ºæ…§åŒ–ä½“éªŒ',
      'Q42': 'å¯¹å¤–å®£ä¼ ä¿¡æ¯è§¦è¾¾',
      'Q43': 'ç¤¾æ•™æ´»åŠ¨ä½“éªŒ',
      'Q44': 'æ–‡åˆ›äº§å“å¸å¼•åŠ›',
      // æ€»ä½“
      'Q45': 'æ•´ä½“æ»¡æ„åº¦',
      // è¡Œä¸ºæ„å‘
      'Q46': 'æ¨èæ„æ„¿',
      'Q47': 'å†æ¬¡å‚è§‚æ„æ„¿',
    };

    let currentStartDate = '';
    let currentEndDate = '';

    async function loadStats() {
      const metaEl = document.getElementById('meta');
      try {
        let url = '/api/stats';
        const params = new URLSearchParams();
        if (currentStartDate) params.set('startDate', currentStartDate);
        if (currentEndDate) params.set('endDate', currentEndDate);
        if (params.toString()) url += '?' + params.toString();

        const resp = await fetch(url);
        if (!resp.ok) throw new Error('æ— æ³•è·å–ç»Ÿè®¡æ•°æ®');
        const data = await resp.json();
        renderStats(data);
        metaEl.textContent = '';
      } catch (err) {
        metaEl.textContent = 'åŠ è½½å¤±è´¥ï¼š' + err.message;
        metaEl.classList.add('error');
      }
    }

    function renderStats(data) {
      const metaEl = document.getElementById('meta');
      metaEl.textContent = `æ€»æäº¤ï¼š${data.count} Â· æœ‰æ•ˆé—®å·ï¼š${data.validCount || data.count} Â· æ›´æ–°äº ${formatTime(data.lastUpdated)}`;
      renderDemographics(data.demographics);
      renderLikert(data.likertStats);
      renderSubmissions(data.submissions);
    }

    function renderDemographics(demo) {
      const container = document.getElementById('demographics');
      container.innerHTML = '';
      Object.entries(demoTitles).forEach(([key, title]) => {
        const card = document.createElement('div');
        card.className = 'card';
        const stats = demo[key] || {};
        card.innerHTML = `<h3>${title}</h3>` +
          Object.keys(stats).map(k => {
            const val = stats[k];
            return `<div class="stat"><span class="label">${k}</span><span class="value">${val}</span></div>`;
          }).join('') || '<div class="empty">æš‚æ— æ•°æ®</div>';
        container.appendChild(card);
      });
    }

    function renderLikert(stats) {
      const tbody = document.querySelector('#likert-table tbody');
      tbody.innerHTML = '';
      Object.entries(stats).forEach(([id, obj]) => {
        const tr = document.createElement('tr');
        const title = scaleTitles[id] || id;
        tr.innerHTML = `
          <td>${id} - ${title}</td>
          <td>${obj.average !== null ? obj.average.toFixed(2) : '-'}
            ${obj.average !== null ? `<span class="pill">è¯„åˆ†</span>` : ''}
          </td>
          <td>${obj.answered}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function formatTime(str) {
      if (!str) return '-';
      const d = new Date(str);
      if (Number.isNaN(d.getTime())) return str;
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function renderSubmissions(submissions) {
      const tbody = document.querySelector('#submissions-table tbody');
      tbody.innerHTML = '';
      if (!submissions || !submissions.length) {
        tbody.innerHTML = '<tr><td colspan="2" class="empty">æš‚æ— è®°å½•</td></tr>';
        return;
      }
      submissions.forEach((s) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${formatTime(s.submittedAt)}</td><td>${s.ip}</td>`;
        tbody.appendChild(tr);
      });
    }

    // æ—¥æœŸç­›é€‰äº‹ä»¶
    document.getElementById('filterBtn').addEventListener('click', () => {
      currentStartDate = document.getElementById('startDate').value;
      currentEndDate = document.getElementById('endDate').value;
      loadStats();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      currentStartDate = '';
      currentEndDate = '';
      loadStats();
    });

    // ä¸‹è½½æ•°æ®äº‹ä»¶
    function downloadData(format) {
      const params = new URLSearchParams();
      params.set('format', format);
      if (currentStartDate) params.set('startDate', currentStartDate);
      if (currentEndDate) params.set('endDate', currentEndDate);
      window.location.href = '/api/download?' + params.toString();
    }

    document.getElementById('downloadCsvBtn').addEventListener('click', () => downloadData('csv'));
    document.getElementById('downloadJsonBtn').addEventListener('click', () => downloadData('json'));

    loadStats();
    setInterval(loadStats, 15000); // æ¯ 15 ç§’åˆ·æ–°ä¸€æ¬¡
  </script>
</body>
</html>
